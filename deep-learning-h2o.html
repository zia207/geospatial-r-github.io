<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Deep Neural Network - Supervised Image Classification in H20 R</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Geospatial Data Science in R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Spatial Data Processing with R
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about.html">Content</a>
    </li>
    <li>
      <a href="getting-started-with-r.html">Getting Started with R</a>
    </li>
    <li>
      <a href="read-write-spatial-data.html">Read and Write Spatial Data in R</a>
    </li>
    <li>
      <a href="map-projection-coordinate-reference-systems.html">Map Projection and Coordinate Reference Systems</a>
    </li>
    <li>
      <a href="geoprocessing-vector-data.html">Geoprocessing of Vector data</a>
    </li>
    <li>
      <a href="working-with-spatial-point-data.html">Working with Spatial Point Data</a>
    </li>
    <li>
      <a href="working-with-spatial-polygon.html">Working with Spatial Polygon Data</a>
    </li>
    <li>
      <a href="working-with-raster-data.html">Working with Raster Data</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Spatial Statistics with R
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about-b.html">Content</a>
    </li>
    <li>
      <a href="spatial-statistics.html">Spatial Statistics</a>
    </li>
    <li>
      <a href="spatial-autocorrelation.html">Spatial Autocorrelation</a>
    </li>
    <li>
      <a href="geographically-weighted-models.html">Geographically Weighted Model</a>
    </li>
    <li>
      <a href="geographically-weighted-summary-statistics.html">Geographically Weighted Summary Statistics</a>
    </li>
    <li>
      <a href="geographically-weighted-principal-components-analysis.html">Geographically Weighted Principal Components Analysis</a>
    </li>
    <li>
      <a href="geographically-weighted-regression.html">Geographically Weighted Regression</a>
    </li>
    <li>
      <a href="spatial-interpolation.html">Spatial Interpolation</a>
    </li>
    <li>
      <a href="deterministic-methods-for-spatial-interpolation.html">Deterministic Methods for Spatial Interpolation</a>
    </li>
    <li>
      <a href="geostatistical-methods-for-spatial-interpolation.html">Geostatistical Methods for Spatial Interpolation</a>
    </li>
    <li>
      <a href="semivariogram-modeling.html">Semivariogram Modeling</a>
    </li>
    <li>
      <a href="kriging.html">Kriging</a>
    </li>
    <li>
      <a href="ordinary-kriging.html">Ordinary Kriging</a>
    </li>
    <li>
      <a href="universal-kriging.html">Universal Kriging</a>
    </li>
    <li>
      <a href="cokriging.html">Co-Kriging</a>
    </li>
    <li>
      <a href="regression-kriging.html">Regression kriging</a>
    </li>
    <li>
      <a href="indicator-kriging.html">Indicator kriging</a>
    </li>
    <li>
      <a href="assessing-quality-spatial-predictions.html">Assessing the Quality of Spatial Predictions</a>
    </li>
    <li>
      <a href="cross-validation.html">Cross-validation</a>
    </li>
    <li>
      <a href="validation-independent-dataset.html.">Validation with an Independent Dataset</a>
    </li>
    <li>
      <a href="conditional-simulation-spatial-uncertainty.html">Conditional Simulation for Spatial Uncertainty</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Remote Sensing Data with R
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="about-c.html">Content</a>
    </li>
    <li>
      <a href="reomte-sensing-basic.html">Remote Sensing Basic</a>
    </li>
    <li>
      <a href="landsat-8-image-processing.html">Landsat 8 Image Processing &amp; Visualization</a>
    </li>
    <li>
      <a href="spectral-indices.html">Spectral Indices</a>
    </li>
    <li>
      <a href="uav-ground-cover.html">Green Ground Cover from UAV Images</a>
    </li>
    <li>
      <a href="texture-analysis.html">Texture Analysis</a>
    </li>
    <li>
      <a href="image-classification.html">Image Classification</a>
    </li>
    <li>
      <a href="ground-truth-data-processing.html">Ground Truth Data Processing</a>
    </li>
    <li>
      <a href="unsupervised-classification.html">Unsupervised Classification</a>
    </li>
    <li>
      <a href="supervised-classification.html">Supervised Classification</a>
    </li>
    <li>
      <a href="random-forest.html">Random Forest</a>
    </li>
    <li>
      <a href="support-vector-machine.html">Support Vector Machine</a>
    </li>
    <li>
      <a href="naive-bayes.html">Naïve Bayes</a>
    </li>
    <li>
      <a href="exboost.html">eXtreme Gradient Boosting</a>
    </li>
    <li>
      <a href="deep-learning-h2o.html">Deep Learning with H20</a>
    </li>
    <li>
      <a href="deep-learning-keras-tensorflow.html">Deep Learning with Keras-TensorFlow</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="mailto:zia207@gmail.com">
    <span class="fa fa-envelope fa-lg"></span>
     
    Email
  </a>
</li>
<li>
  <a href="http://github.com/zia207">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://www.linkedin.com/in/zia-ahmed-a7653578">
    <span class="fa fa-linkedin fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Deep Neural Network - Supervised Image Classification in H20 R</h1>

</div>


<div style="margin-bottom:30px;">

</div>
<p><strong>Deep Neural Networks (or Deep Dearning)</strong> is based on a multi-layer, feed-forward artificial neural network that is trained with stochastic gradient descent using back-propagation. The network can contain many hidden layers consisting of neurons with activation functions. Advanced features such as adaptive learning rate, rate annealing, momentum training, dropout, L1 or L2 regularization, checkpointing, and grid search enable high predictive accuracy. Each computer node trains a copy of the global model parameters on its local data with multi-threading (asynchronously) and contributes periodically to the global model via model averaging across the network.</p>
<p>In this tutorial will show how to implement a Deep Neural Network for pixel based supervised classification of Sentinel-2 multispectral images using the <a href="http://h2o-release.s3.amazonaws.com/h2o/rel-lambert/5/docs-website/Ruser/Rinstall.html">H20</a> package in R.</p>
<p><a href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/welcome.html">H2O is an open source, in-memory, distributed, fast, and scalable machine learning and predictive analytics platform that allows you to build machine learning models on big data and provides easy productionalization of those models in an enterprise environment</a>. It’s core code is written in Java and can read data in parallel from a distributed cluster and also from local cluster. H2O allows access to all the capabilities of H2O from an external program or script via JSON over HTTP. The Rest API is used by H2O’s <a href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/welcome.html">web interface (Flow UI)</a>, <a href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/welcome.html">R binding (H2O-R)</a>, and <a href="http://docs.h2o.ai/h2o/latest-stable/h2o-docs/welcome.html">Python binding (H2O-Python)</a>. Requirement and installation steps in R can be found <a href="http://h2o-release.s3.amazonaws.com/h2o/rel-wheeler/2/index.html">here</a>.</p>
<p>First, we will split the “point_data” into a training set (75% of the data), a validation set (12%) and a test set (13%) data. The validation data set will be used to optimize the model parameters during the training process. The model’s performance will be tested with the test data set. Finally, we will predict land use classes using a grid data set.</p>
<p><strong>Tuning and Optimizations parameters:</strong></p>
<ul>
<li><p>Four hidden layers with 200 neurons and Rectifier Linear (ReLU) as an activation function for the of neurons.</p></li>
<li><p>The default stochastic gradient descent function will be used to optimize different objective functions and to minimize the training loss.</p></li>
<li><p>To reduce the generalization error and the risk of over-fitting of the model, we will use set low values for L1 and L2 regularizations.</p></li>
<li><p>The model will be cross validated with 10 folds with stratified sampling</p></li>
<li><p>The model will be run with 100 epochs.</p></li>
</ul>
<p>More details about the of Tuning and Optimization parameters of the H20 Deep Neural Network for supervised classification can be found <a href="http://docs.h2o.ai/h2o-tutorials/latest-stable/tutorials/deeplearning/index.html">here</a></p>
<div id="load-packages" class="section level4">
<h4>Load packages</h4>
<pre class="r"><code>library(rgdal)         # spatial data processing
library(raster)        # raster processing
library(plyr)          # data manipulation 
library(dplyr)         # data manipulation 
library(RStoolbox)     # plotting raster data 
library(ggplot2)       # plotting 
library(RColorBrewer)  # Color
library(sp)            # Spatial data
library(ggplot2)       # Plotting</code></pre>
<div style="margin-bottom:20px;">

</div>
<p>The data could be available for download from <a href="https://www.dropbox.com/s/ybh1kr487wrhl8i/DATA_09.7z?dl=0">here</a>.</p>
<div style="margin-bottom:20px;">

</div>
<pre class="r"><code># Define data folder
dataFolder&lt;-&quot;F://Spatial_Data_Processing_and_Analysis_R//Data//DATA_09//&quot;</code></pre>
</div>
<div id="load-point-and-grid-data" class="section level4">
<h4>Load point and grid data</h4>
<pre class="r"><code>point&lt;-read.csv(paste0(dataFolder,&quot;.\\Sentinel_2\\point_data.csv&quot;), header = T)
grid&lt;-read.csv(paste0(dataFolder,&quot;.\\Sentinel_2\\prediction_grid_data.csv&quot;), header = T)</code></pre>
<div id="creat-data-frames" class="section level5">
<h5>Creat data frames</h5>
<pre class="r"><code>point.data&lt;-cbind(point[c(3:13)])
grid.data&lt;-grid[c(4:13)]
grid.xy&lt;-grid[c(3,1:2)]</code></pre>
</div>
</div>
<div id="install-h2o" class="section level4">
<h4>Install H2O</h4>
<pre class="r"><code>#install.packages(&quot;h20&quot;)</code></pre>
</div>
<div id="start-and-initialize-h20-local-cluster" class="section level4">
<h4>Start and Initialize H20 local cluster</h4>
<pre class="r"><code>library(h2o)
localH2o &lt;- h2o.init(nthreads = -1) </code></pre>
</div>
<div id="import-data-to-h2o-cluster" class="section level4">
<h4>Import data to H2O cluster</h4>
<pre class="r"><code>df&lt;-  as.h2o(point.data)
grid&lt;- as.h2o(grid.data)</code></pre>
</div>
<div id="split-data-into-train-validation-and-test-dataset" class="section level4">
<h4>Split data into train, validation and test dataset</h4>
<pre class="r"><code>splits &lt;- h2o.splitFrame(df, c(0.75,0.125), seed=1234)
train  &lt;- h2o.assign(splits[[1]], &quot;train.hex&quot;) # 75%
valid  &lt;- h2o.assign(splits[[2]], &quot;valid.hex&quot;) # 12%
test   &lt;- h2o.assign(splits[[3]], &quot;test.hex&quot;)  # 13%</code></pre>
</div>
<div id="create-response-and-features-data-sets" class="section level4">
<h4>Create response and features data sets</h4>
<pre class="r"><code>y &lt;- &quot;Class&quot;
x &lt;- setdiff(names(train), y)</code></pre>
<div style="margin-bottom:20px;">

</div>
</div>
<div id="model-fitting" class="section level3">
<h3>Model Fitting</h3>
<pre class="r"><code>dl_model &lt;- h2o.deeplearning(
              model_id=&quot;Deep_Learning&quot;,                  # Destination id for this model
              training_frame=train,                      # Id of the training data frame
              validation_frame=valid,                    # Id of the validation data frame 
              x=x,                                       # a vector predictor variable
              y=y,                                       # name of reponse vaiables
              standardize=TRUE,                          # standardize the data
              score_training_samples=0,                  # training set samples for scoring (0 for all)
              activation = &quot;RectifierWithDropout&quot;,       # Activation function
              score_each_iteration = TRUE,              
              hidden = c(200,200,200,200),               # 4 hidden layers, each of 200 neurons
              hidden_dropout_ratios=c(0.2,0.1,0.1,0),    # for improve generalization
              stopping_tolerance = 0.001,                # tolerance for metric-based stopping criterion
              epochs=10,                                # the dataset should be iterated (streamed)
              adaptive_rate=TRUE,                        # manually tuned learning rate
              l1=1e-6,                                   # L1/L2 regularization, improve generalization
              l2=1e-6,
              max_w2=10,                                 # helps stability for Rectifier
              nfolds=10,                                 # Number of folds for K-fold cross-validation
              fold_assignment=&quot;Stratified&quot;,              # Cross-validation fold assignment scheme
              keep_cross_validation_fold_assignment = TRUE,
              seed=125,
              reproducible = TRUE,
              variable_importances=T
        ) </code></pre>
<div id="model-summary" class="section level4">
<h4>Model Summary</h4>
<pre class="r"><code>summary(dl_model)</code></pre>
<pre><code>## Model Details:
## ==============
## 
## H2OMultinomialModel: deeplearning
## Model Key:  Deep_Learning 
## Status of Neuron Layers: predicting Class, 5-class classification, multinomial distribution, CrossEntropy loss, 123,805 weights/biases, 1.4 MB, 198,374 training samples, mini-batch size 1
##   layer units             type dropout       l1       l2 mean_rate
## 1     1    10            Input  0.00 %                            
## 2     2   200 RectifierDropout 20.00 % 0.000001 0.000001  0.002778
## 3     3   200 RectifierDropout 10.00 % 0.000001 0.000001  0.017429
## 4     4   200 RectifierDropout 10.00 % 0.000001 0.000001  0.009463
## 5     5   200 RectifierDropout  0.00 % 0.000001 0.000001  0.026793
## 6     6     5          Softmax         0.000001 0.000001  0.044096
##   rate_rms momentum mean_weight weight_rms mean_bias bias_rms
## 1                                                            
## 2 0.001755 0.000000    0.065016   0.182215  0.360042 0.080736
## 3 0.017699 0.000000   -0.029830   0.097819  0.916611 0.146557
## 4 0.012781 0.000000   -0.016788   0.078863  0.962554 0.029205
## 5 0.042380 0.000000   -0.007376   0.079870  0.835408 0.249331
## 6 0.168842 0.000000   -0.120609   0.190814 -0.182675 0.108195
## 
## H2OMultinomialMetrics: deeplearning
## ** Reported on training data. **
## ** Metrics reported on full training frame **
## 
## Training Set Metrics: 
## =====================
## 
## Extract training frame with `h2o.getFrame(&quot;train.hex&quot;)`
## MSE: (Extract with `h2o.mse`) 0.02795736
## RMSE: (Extract with `h2o.rmse`) 0.1672045
## Logloss: (Extract with `h2o.logloss`) 0.09567308
## Mean Per-Class Error: 0.02936676
## Confusion Matrix: Extract with `h2o.confusionMatrix(&lt;model&gt;,train = TRUE)`)
## =========================================================================
## Confusion Matrix: Row labels: Actual class; Column labels: Predicted class
##         Class_1 Class_2 Class_3 Class_4 Class_5  Error           Rate
## Class_1    4036     129       1       0       0 0.0312 =  130 / 4,166
## Class_2     153    3108      59       0       0 0.0639 =  212 / 3,320
## Class_3     169      11    5871      64       0 0.0399 =  244 / 6,115
## Class_4       0       0      39    3700       0 0.0104 =   39 / 3,739
## Class_5       0       0       1       0     693 0.0014 =      1 / 694
## Totals     4358    3248    5971    3764     693 0.0347 = 626 / 18,034
## 
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;,train = TRUE)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.965288
## 2 2  0.997727
## 3 3  0.999834
## 4 4  1.000000
## 5 5  1.000000
## 
## 
## H2OMultinomialMetrics: deeplearning
## ** Reported on validation data. **
## ** Metrics reported on full validation frame **
## 
## Validation Set Metrics: 
## =====================
## 
## Extract validation frame with `h2o.getFrame(&quot;valid.hex&quot;)`
## MSE: (Extract with `h2o.mse`) 0.02696643
## RMSE: (Extract with `h2o.rmse`) 0.1642146
## Logloss: (Extract with `h2o.logloss`) 0.09223192
## Mean Per-Class Error: 0.02655379
## Confusion Matrix: Extract with `h2o.confusionMatrix(&lt;model&gt;,valid = TRUE)`)
## =========================================================================
## Confusion Matrix: Row labels: Actual class; Column labels: Predicted class
##         Class_1 Class_2 Class_3 Class_4 Class_5  Error         Rate
## Class_1     643      17       0       0       0 0.0258 =   17 / 660
## Class_2      14     517      13       0       0 0.0496 =   27 / 544
## Class_3      30       3     962       8       0 0.0409 = 41 / 1,003
## Class_4       0       0      10     596       0 0.0165 =   10 / 606
## Class_5       0       0       0       0     111 0.0000 =    0 / 111
## Totals      687     537     985     604     111 0.0325 = 95 / 2,924
## 
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;,valid = TRUE)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.967510
## 2 2  0.997264
## 3 3  0.999658
## 4 4  1.000000
## 5 5  1.000000
## 
## 
## H2OMultinomialMetrics: deeplearning
## ** Reported on cross-validation data. **
## ** 10-fold cross-validation on training data (Metrics computed for combined holdout predictions) **
## 
## Cross-Validation Set Metrics: 
## =====================
## 
## Extract cross-validation frame with `h2o.getFrame(&quot;train.hex&quot;)`
## MSE: (Extract with `h2o.mse`) 0.02485955
## RMSE: (Extract with `h2o.rmse`) 0.1576691
## Logloss: (Extract with `h2o.logloss`) 0.08782037
## Mean Per-Class Error: 0.03186191
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;,xval = TRUE)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.967728
## 2 2  0.997948
## 3 3  0.999778
## 4 4  1.000000
## 5 5  1.000000
## 
## 
## Cross-Validation Metrics Summary: 
##                                mean           sd  cv_1_valid  cv_2_valid
## accuracy                  0.9677325  0.004471162   0.9624711  0.95986986
## err                     0.032267496  0.004471162  0.03752887 0.040130153
## err_count                      58.2     8.184131        65.0        74.0
## logloss                  0.08777085 0.0064328457  0.08648893  0.10182433
## max_per_class_error      0.05970799  0.011646003  0.09198813 0.061946902
## mean_per_class_accuracy   0.9683733  0.005520481   0.9589077   0.9662665
## mean_per_class_error    0.031626694  0.005520481 0.041092273 0.033733465
## mse                     0.024850236 0.0019925938 0.025631974 0.028764095
## r2                        0.9814064 0.0016099928  0.98136055  0.97792244
## rmse                      0.1573793 0.0064027845   0.1600999   0.1695998
##                          cv_3_valid  cv_4_valid  cv_5_valid  cv_6_valid
## accuracy                  0.9775834   0.9651036   0.9725028   0.9720045
## err                     0.022416621   0.0348964 0.027497195 0.027995521
## err_count                      41.0        64.0        49.0        50.0
## logloss                  0.07523714 0.101950675  0.07775727 0.089568794
## max_per_class_error     0.042735044  0.05940594 0.046838406 0.042600896
## mean_per_class_accuracy  0.98057896    0.963337  0.97552365  0.97674614
## mean_per_class_error     0.01942106 0.036662996  0.02447634 0.023253873
## mse                     0.020924417 0.027235886 0.020564312 0.025608951
## r2                        0.9839026   0.9789827  0.98461586  0.98124653
## rmse                     0.14465275  0.16503298  0.14340262  0.16002797
##                          cv_7_valid  cv_8_valid  cv_9_valid cv_10_valid
## accuracy                 0.96585906  0.96629214  0.97675705  0.95888156
## err                      0.03414097 0.033707865 0.023242945  0.04111842
## err_count                      62.0        60.0        42.0        75.0
## logloss                  0.08825625  0.09100033   0.0754986   0.0901262
## max_per_class_error     0.054545455  0.06709265 0.045180723 0.084745765
## mean_per_class_accuracy   0.9645262  0.96686643   0.9751393   0.9558411
## mean_per_class_error      0.0354738  0.03313359 0.024860684 0.044158857
## mse                     0.024415873 0.026147075 0.021330735 0.027879043
## r2                         0.981828   0.9807052  0.98461044   0.9788895
## rmse                      0.1562558  0.16170058  0.14605045  0.16697018
## 
## Scoring History: 
##              timestamp          duration training_speed   epochs
## 1  2019-10-15 18:44:19         0.000 sec                 0.00000
## 2  2019-10-15 18:44:37  3 min 25.928 sec   1056 obs/sec  1.00000
## 3  2019-10-15 18:44:53  3 min 42.052 sec   1147 obs/sec  2.00000
## 4  2019-10-15 18:45:07  3 min 56.659 sec   1221 obs/sec  3.00000
## 5  2019-10-15 18:45:21  4 min 10.270 sec   1284 obs/sec  4.00000
## 6  2019-10-15 18:45:36  4 min 24.924 sec   1305 obs/sec  5.00000
## 7  2019-10-15 18:45:49  4 min 37.840 sec   1348 obs/sec  6.00000
## 8  2019-10-15 18:46:02  4 min 50.726 sec   1380 obs/sec  7.00000
## 9  2019-10-15 18:46:14  5 min  3.508 sec   1409 obs/sec  8.00000
## 10 2019-10-15 18:46:27  5 min 15.886 sec   1436 obs/sec  9.00000
## 11 2019-10-15 18:46:39  5 min 28.416 sec   1458 obs/sec 10.00000
## 12 2019-10-15 18:46:52  5 min 40.711 sec   1477 obs/sec 11.00000
##    iterations       samples training_rmse training_logloss training_r2
## 1           0      0.000000                                           
## 2           1  18034.000000       0.30807          0.31402     0.92909
## 3           2  36068.000000       0.23927          0.18531     0.95723
## 4           3  54102.000000       0.22067          0.16103     0.96362
## 5           4  72136.000000       0.19930          0.13696     0.97032
## 6           5  90170.000000       0.19737          0.12817     0.97090
## 7           6 108204.000000       0.18215          0.11356     0.97521
## 8           7 126238.000000       0.19155          0.12144     0.97259
## 9           8 144272.000000       0.16898          0.09833     0.97867
## 10          9 162306.000000       0.17510          0.10775     0.97709
## 11         10 180340.000000       0.15287          0.08055     0.98254
## 12         11 198374.000000       0.16720          0.09567     0.97911
##    training_classification_error validation_rmse validation_logloss
## 1                                                                  
## 2                        0.11761         0.30326            0.30153
## 3                        0.06920         0.24144            0.18801
## 4                        0.06155         0.21938            0.15935
## 5                        0.05040         0.19581            0.13044
## 6                        0.05251         0.19743            0.12780
## 7                        0.04148         0.17582            0.10935
## 8                        0.04614         0.18189            0.10908
## 9                        0.03865         0.16148            0.09300
## 10                       0.03931         0.17383            0.10595
## 11                       0.03488         0.15253            0.08104
## 12                       0.03471         0.16421            0.09223
##    validation_r2 validation_classification_error
## 1                                               
## 2        0.93046                         0.11491
## 3        0.95592                         0.07182
## 4        0.96361                         0.06224
## 5        0.97101                         0.04822
## 6        0.97053                         0.05198
## 7        0.97663                         0.03933
## 8        0.97498                         0.04104
## 9        0.98028                         0.03146
## 10       0.97715                         0.03933
## 11       0.98241                         0.03249
## 12       0.97961                         0.03249
## 
## Variable Importances: (Extract with `h2o.varimp`) 
## =================================================
## 
## Variable Importances: 
##    variable relative_importance scaled_importance percentage
## 1        B2            1.000000          1.000000   0.135410
## 2        B5            0.912811          0.912811   0.123604
## 3       B11            0.903498          0.903498   0.122343
## 4       B12            0.837021          0.837021   0.113341
## 5        B3            0.805251          0.805251   0.109039
## 6        B4            0.755519          0.755519   0.102305
## 7        B8            0.698427          0.698427   0.094574
## 8        B6            0.521599          0.521599   0.070630
## 9       B8A            0.489297          0.489297   0.066256
## 10       B7            0.461545          0.461545   0.062498</code></pre>
<pre class="r"><code>#capture.output(print(summary(dl_model)),file =  &quot;DL_summary_model_01.txt&quot;)</code></pre>
</div>
<div id="mean-error" class="section level4">
<h4>Mean error</h4>
<pre class="r"><code>h2o.mean_per_class_error(dl_model, train = TRUE, valid = TRUE, xval = TRUE)</code></pre>
<pre><code>##      train      valid       xval 
## 0.02936676 0.02655379 0.03186191</code></pre>
</div>
<div id="scoring-history" class="section level4">
<h4>Scoring history</h4>
<pre class="r"><code>scoring_history&lt;-dl_model@model$scoring_history
#scoring_history
#write.csv(scoring_history, &quot;scoring_history_model_02.csv&quot;)</code></pre>
</div>
<div id="plot-the-classification-error" class="section level4">
<h4>Plot the classification error</h4>
<pre class="r"><code>plot(dl_model,
     timestep = &quot;epochs&quot;,
     metric = &quot;classification_error&quot;)</code></pre>
<p><img src="deep-learning-h2o_files/figure-html/unnamed-chunk-14-1.png" width="480" /></p>
</div>
<div id="plot-logloss" class="section level4">
<h4>Plot logloss</h4>
<pre class="r"><code>plot(dl_model,
     timestep = &quot;epochs&quot;,
     metric = &quot;logloss&quot;)</code></pre>
<p><img src="deep-learning-h2o_files/figure-html/unnamed-chunk-15-1.png" width="480" /></p>
</div>
<div id="cross-validation-error" class="section level4">
<h4>Cross-validation Error</h4>
<pre class="r"><code># Get the CV models from the deeplearning model object` object
cv_models &lt;- sapply(dl_model@model$cross_validation_models, 
                    function(i) h2o.getModel(i$name))
# Plot the scoring history over time
plot(cv_models[[1]], 
     timestep = &quot;epochs&quot;, 
     metric = &quot;classification_error&quot;)</code></pre>
<p><img src="deep-learning-h2o_files/figure-html/unnamed-chunk-16-1.png" width="480" /></p>
</div>
<div id="cross-validation-result" class="section level4">
<h4>Cross validation result</h4>
<pre class="r"><code>print(dl_model@model$cross_validation_metrics_summary%&gt;%.[,c(1,2)])</code></pre>
<pre><code>##                                mean           sd
## accuracy                  0.9677325  0.004471162
## err                     0.032267496  0.004471162
## err_count                      58.2     8.184131
## logloss                  0.08777085 0.0064328457
## max_per_class_error      0.05970799  0.011646003
## mean_per_class_accuracy   0.9683733  0.005520481
## mean_per_class_error    0.031626694  0.005520481
## mse                     0.024850236 0.0019925938
## r2                        0.9814064 0.0016099928
## rmse                      0.1573793 0.0064027845</code></pre>
<pre class="r"><code>#capture.output(print(dl_model@model$cross_validation_metrics_summary%&gt;%.[,c(1,2)]),file =  &quot;DL_CV_model_01.txt&quot;)</code></pre>
</div>
<div id="model-performance-with-test-data-set" class="section level4">
<h4>Model performance with Test data set</h4>
</div>
<div id="compare-the-training-error-with-the-validation-and-test-set-errors" class="section level4">
<h4>Compare the training error with the validation and test set errors</h4>
<pre class="r"><code>h2o.performance(dl_model, newdata=train)     ## full train data</code></pre>
<pre><code>## H2OMultinomialMetrics: deeplearning
## 
## Test Set Metrics: 
## =====================
## 
## MSE: (Extract with `h2o.mse`) 0.02795736
## RMSE: (Extract with `h2o.rmse`) 0.1672045
## Logloss: (Extract with `h2o.logloss`) 0.09567308
## Mean Per-Class Error: 0.02936676
## Confusion Matrix: Extract with `h2o.confusionMatrix(&lt;model&gt;, &lt;data&gt;)`)
## =========================================================================
## Confusion Matrix: Row labels: Actual class; Column labels: Predicted class
##         Class_1 Class_2 Class_3 Class_4 Class_5  Error           Rate
## Class_1    4036     129       1       0       0 0.0312 =  130 / 4,166
## Class_2     153    3108      59       0       0 0.0639 =  212 / 3,320
## Class_3     169      11    5871      64       0 0.0399 =  244 / 6,115
## Class_4       0       0      39    3700       0 0.0104 =   39 / 3,739
## Class_5       0       0       1       0     693 0.0014 =      1 / 694
## Totals     4358    3248    5971    3764     693 0.0347 = 626 / 18,034
## 
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;, &lt;data&gt;)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.965288
## 2 2  0.997727
## 3 3  0.999834
## 4 4  1.000000
## 5 5  1.000000</code></pre>
<pre class="r"><code>h2o.performance(dl_model, newdata=valid)     ## full validation data</code></pre>
<pre><code>## H2OMultinomialMetrics: deeplearning
## 
## Test Set Metrics: 
## =====================
## 
## MSE: (Extract with `h2o.mse`) 0.02696643
## RMSE: (Extract with `h2o.rmse`) 0.1642146
## Logloss: (Extract with `h2o.logloss`) 0.09223192
## Mean Per-Class Error: 0.02655379
## Confusion Matrix: Extract with `h2o.confusionMatrix(&lt;model&gt;, &lt;data&gt;)`)
## =========================================================================
## Confusion Matrix: Row labels: Actual class; Column labels: Predicted class
##         Class_1 Class_2 Class_3 Class_4 Class_5  Error         Rate
## Class_1     643      17       0       0       0 0.0258 =   17 / 660
## Class_2      14     517      13       0       0 0.0496 =   27 / 544
## Class_3      30       3     962       8       0 0.0409 = 41 / 1,003
## Class_4       0       0      10     596       0 0.0165 =   10 / 606
## Class_5       0       0       0       0     111 0.0000 =    0 / 111
## Totals      687     537     985     604     111 0.0325 = 95 / 2,924
## 
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;, &lt;data&gt;)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.967510
## 2 2  0.997264
## 3 3  0.999658
## 4 4  1.000000
## 5 5  1.000000</code></pre>
<pre class="r"><code>h2o.performance(dl_model, newdata=test)     ## full test data</code></pre>
<pre><code>## H2OMultinomialMetrics: deeplearning
## 
## Test Set Metrics: 
## =====================
## 
## MSE: (Extract with `h2o.mse`) 0.02619048
## RMSE: (Extract with `h2o.rmse`) 0.1618347
## Logloss: (Extract with `h2o.logloss`) 0.08859117
## Mean Per-Class Error: 0.02621799
## Confusion Matrix: Extract with `h2o.confusionMatrix(&lt;model&gt;, &lt;data&gt;)`)
## =========================================================================
## Confusion Matrix: Row labels: Actual class; Column labels: Predicted class
##         Class_1 Class_2 Class_3 Class_4 Class_5  Error         Rate
## Class_1     684      23       1       0       0 0.0339 =   24 / 708
## Class_2      14     543       8       0       0 0.0389 =   22 / 565
## Class_3      34       2     936       7       0 0.0439 =   43 / 979
## Class_4       0       0       9     619       0 0.0143 =    9 / 628
## Class_5       0       0       0       0     107 0.0000 =    0 / 107
## Totals      732     568     954     626     107 0.0328 = 98 / 2,987
## 
## Hit Ratio Table: Extract with `h2o.hit_ratio_table(&lt;model&gt;, &lt;data&gt;)`
## =======================================================================
## Top-5 Hit Ratios: 
##   k hit_ratio
## 1 1  0.967191
## 2 2  0.996987
## 3 3  1.000000
## 4 4  1.000000
## 5 5  1.000000</code></pre>
<pre class="r"><code>#capture.output(print(h2o.performance(dl_model,test)),file =  &quot;test_data_model_01.txt&quot;)</code></pre>
</div>
<div id="confusion-matrix" class="section level4">
<h4>Confusion matrix</h4>
<pre class="r"><code>train.cf&lt;-h2o.confusionMatrix(dl_model)
print(train.cf)
valid.cf&lt;-h2o.confusionMatrix(dl_model,valid=TRUE)
print(valid.cf)
test.cf&lt;-h2o.confusionMatrix(dl_model,test)
print(test.cf)
#write.csv(train.cf, &quot;CFM_train_model_01.csv&quot;)
#write.csv(valid.cf, &quot;CFM_valid_model_01.csv&quot;)
#write.csv(test.cf, &quot;CFM_test_moldel_01.csv&quot;)</code></pre>
</div>
<div id="grid-prediction" class="section level4">
<h4>Grid Prediction</h4>
<pre class="r"><code>g.predict = as.data.frame(h2o.predict(object = dl_model, newdata = grid))</code></pre>
</div>
<div id="stop-h20-cluster" class="section level4">
<h4>Stop h20 cluster</h4>
<pre class="r"><code># h2o.shutdown(prompt=FALSE)</code></pre>
</div>
<div id="extract-prediction-class" class="section level4">
<h4>Extract Prediction Class</h4>
<pre class="r"><code># Extract predicted landuse class
grid.xy$Class&lt;-g.predict$predict  
# Import lnaduse ID file 
ID&lt;-read.csv(paste0(dataFolder,&quot;.\\Sentinel_2\\Landuse_ID.csv&quot;), header=T)
# Join landuse ID
grid.new&lt;-join(grid.xy, ID, by=&quot;Class&quot;, type=&quot;inner&quot;) 
# Omit missing values
grid.new.na&lt;-na.omit(grid.new)                                                            </code></pre>
</div>
<div id="convert-to-raster-and-write" class="section level4">
<h4>Convert to raster and write</h4>
<pre class="r"><code>x&lt;-SpatialPointsDataFrame(as.data.frame(grid.new.na)[, c(&quot;x&quot;, &quot;y&quot;)], data = grid.new.na)
r &lt;- rasterFromXYZ(as.data.frame(x)[, c(&quot;x&quot;, &quot;y&quot;, &quot;Class_ID&quot;)])</code></pre>
</div>
<div id="plot-map" class="section level4">
<h4>Plot map</h4>
<pre class="r"><code># Create color palette
myPalette &lt;- colorRampPalette(c(&quot;light grey&quot;,&quot;burlywood4&quot;, &quot;forestgreen&quot;,&quot;light green&quot;, &quot;dodgerblue&quot;))
# Plot Map
LU&lt;-spplot(r,&quot;Class_ID&quot;, main=&quot;Supervised Image Classification: Deep Learning-H20&quot; , 
      colorkey = list(space=&quot;right&quot;,tick.number=1,height=1, width=1.5,
              labels = list(at = seq(1,4.8,length=5),cex=1.0,
              lab = c(&quot;Road/parking/pavement&quot; ,&quot;Building&quot;, &quot;Tree/buses&quot;, &quot;Grass&quot;, &quot;Water&quot;))),
              col.regions=myPalette,cut=4)
LU</code></pre>
<p><img src="deep-learning-h2o_files/figure-html/unnamed-chunk-24-1.png" width="624" style="display: block; margin: auto;" /></p>
</div>
<div id="write-raster" class="section level4">
<h4>Write raster</h4>
<pre class="r"><code># writeRaster(r, filename = paste0(dataFolder,&quot;.\\Sentinel_2\\DNN_H20_Landuse.tiff&quot;), &quot;GTiff&quot;, overwrite=T)</code></pre>
<pre class="r"><code>rm(list = ls())</code></pre>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
